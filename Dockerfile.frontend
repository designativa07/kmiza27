# üé® Dockerfile para Frontend Next.js - Easypanel (PRODU√á√ÉO OTIMIZADA)
FROM node:18-alpine

# Instalar depend√™ncias do sistema
RUN apk add --no-cache curl git

# Definir diret√≥rio de trabalho
WORKDIR /app

# Quebrar cache - vers√£o 8.14 (PRODU√á√ÉO OTIMIZADA - LOGS REDUZIDOS)
RUN echo "Frontend build version 8.14 - PRODUCTION OPTIMIZED - $(date)"

# Download direto do GitHub e c√≥pia espec√≠fica do frontend
RUN cd /tmp && \
    git clone https://github.com/designativa07/kmiza27.git repo && \
    cp -r /tmp/repo/frontend/. /app/ && \
    rm -rf /tmp/repo

# Instalar depend√™ncias do frontend
RUN npm ci --legacy-peer-deps --silent

# Build da aplica√ß√£o Next.js com vari√°vel de ambiente correta
RUN NEXT_PUBLIC_API_URL="https://kmizabot.h4xd66.easypanel.host" \
    NODE_ENV=production \
    DISABLE_ESLINT_PLUGIN=true \
    npm run build

# Copiar arquivos standalone para diret√≥rio limpo
RUN cp -r /app/.next/standalone /app/standalone && \
    cp -r /app/.next/static /app/standalone/.next/static && \
    if [ -d "/app/public" ]; then \
        cp -r /app/public /app/standalone/public; \
    else \
        mkdir -p /app/standalone/public; \
    fi

# Limpar arquivos desnecess√°rios
RUN rm -rf /app/node_modules /app/.next /app/src && \
    npm cache clean --force

# Mover para diret√≥rio standalone
WORKDIR /app/standalone

# Criar script de startup otimizado
RUN echo '#!/bin/sh' > /app/standalone/startup.sh && \
    echo 'export PORT=3002' >> /app/standalone/startup.sh && \
    echo 'export HOSTNAME="0.0.0.0"' >> /app/standalone/startup.sh && \
    echo 'export NODE_ENV=production' >> /app/standalone/startup.sh && \
    echo 'export NEXT_PUBLIC_API_URL="https://kmizabot.h4xd66.easypanel.host"' >> /app/standalone/startup.sh && \
    echo 'echo "üöÄ Frontend v8.14 starting on port $PORT with API: $NEXT_PUBLIC_API_URL" >&2' >> /app/standalone/startup.sh && \
    echo 'exec node server.js' >> /app/standalone/startup.sh && \
    chmod +x /app/standalone/startup.sh

# Expor porta do Next.js
EXPOSE 3002

# Configurar vari√°veis de ambiente
ENV PORT=3002
ENV NODE_ENV=production
ENV HOSTNAME="0.0.0.0"
ENV NODE_OPTIONS="--max-old-space-size=512"
ENV NEXT_PUBLIC_API_URL="https://kmizabot.h4xd66.easypanel.host"

# Usar startup script otimizado
CMD ["/bin/sh", "/app/standalone/startup.sh"] 