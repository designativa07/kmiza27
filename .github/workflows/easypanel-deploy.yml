name: ðŸš€ Auto Deploy to EasyPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“ Get commit info
      id: commit
      run: |
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        
    - name: ðŸ” Display commit info
      run: |
        echo "ðŸ”„ Deploying commit: ${{ steps.commit.outputs.short_sha }}"
        echo "ðŸ“… Timestamp: ${{ steps.commit.outputs.timestamp }}"
        
    - name: ðŸš€ Trigger EasyPanel Deploy (Backend)
      run: |
        echo "ðŸ”§ Triggering backend deploy..."
        # EasyPanel detectarÃ¡ automaticamente o push via webhook
        # Este step Ã© apenas para logging
        
    - name: ðŸŽ¨ Trigger EasyPanel Deploy (Frontend)
      run: |
        echo "ðŸ”§ Triggering frontend deploy..."
        # EasyPanel detectarÃ¡ automaticamente o push via webhook
        # Este step Ã© apenas para logging
        
    - name: â³ Wait for deployment
      run: |
        echo "â³ Aguardando deploy completar..."
        sleep 60
        
    - name: ðŸ§ª Verify deployment
      run: |
        echo "ðŸ§ª Verificando deploy..."
        
        # Verificar backend
        BACKEND_RESPONSE=$(curl -s https://kmizabot.h4xd66.easypanel.host/health || echo '{"commit":"error"}')
        BACKEND_COMMIT=$(echo $BACKEND_RESPONSE | jq -r '.commit // "error"')
        echo "ðŸ”§ Backend commit: $BACKEND_COMMIT"
        
        # Verificar frontend
        FRONTEND_RESPONSE=$(curl -s https://kmizafrontend.h4xd66.easypanel.host/api/health || echo '{"commit":"error"}')
        FRONTEND_COMMIT=$(echo $FRONTEND_RESPONSE | jq -r '.commit // "error"')
        echo "ðŸŽ¨ Frontend commit: $FRONTEND_COMMIT"
        
        # Comparar commits
        EXPECTED_COMMIT="${{ steps.commit.outputs.sha }}"
        
        if [ "$BACKEND_COMMIT" = "$EXPECTED_COMMIT" ] && [ "$FRONTEND_COMMIT" = "$EXPECTED_COMMIT" ]; then
          echo "âœ… Deploy completado com sucesso!"
          echo "ðŸŽ¯ Ambos os serviÃ§os estÃ£o atualizados"
        else
          echo "âš ï¸ Deploy pode ainda estar em progresso"
          echo "ðŸ”„ Backend: $BACKEND_COMMIT"
          echo "ðŸ”„ Frontend: $FRONTEND_COMMIT"
          echo "ðŸŽ¯ Esperado: $EXPECTED_COMMIT"
        fi
        
    - name: ðŸ“Š Deploy Summary
      run: |
        echo "## ðŸš€ Deploy Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ steps.commit.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** ${{ steps.commit.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend URL:** https://kmizabot.h4xd66.easypanel.host/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend URL:** https://kmizafrontend.h4xd66.easypanel.host/api/health" >> $GITHUB_STEP_SUMMARY
        echo "- **Status Dashboard:** https://kmizafrontend.h4xd66.easypanel.host/status" >> $GITHUB_STEP_SUMMARY 